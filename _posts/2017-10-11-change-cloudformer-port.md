---
layout: post
title: Use CloudFormer in AWS Beijing
subtitle: Change default ports of a EC2 machine generated by a CloudFormation template in AWS CN
published: true
tags: aws
---

So, I happened upon a particularly tricky issue. I am using the AWS Beijing Region (`cn-north-1`) and I wanted to create a CloudFormation template of our environment. Amazon provides a template called CloudFormer in their [CloudFormation page](https://console.amazonaws.cn/cloudformation/home?region=cn-north-1#/stacks/new)

![image](https://user-images.githubusercontent.com/32394146/31493882-a8fd6758-af83-11e7-9f67-d857a770d4b1.png)

What this does is create an EC2 instance based on that template as well as the resoruces below:

![image](https://user-images.githubusercontent.com/32394146/31493939-d9611c5a-af83-11e7-9125-5a9113dc7421.png)

Once the stack is created, on the Outputs tab in CloudFormation, you can see the endpoint URL that you use to access the application. 

![image](https://user-images.githubusercontent.com/32394146/31494006-20c9e518-af84-11e7-96a1-a5be2b8d5624.png)

If you try to access this, it doesn't work. The reason is due to China regulations, the default web application ports of 80 and 443 are blocked. So how do we access CloudFormer to generate our stack? Well, we change the default port for our application from 443 to another one, say 8443. To do so, we'd need to ssh into the EC2 instance, change the ports and we should be good. Right? Well, it wasn't that easy. 

# Add SSH Key to EC2 machine
First, what is the SSH key associated with this isntance? Well it seems there are no keys associated with this instance - because the creators of this template didn't need to provide one. There's no need to. But we need access. So we'd need to find a way to add a key to an existing EC2 instance. Researching this line - it seemed a bit or work. An easier way would be if we clould have the CloudFormer template to associate a key with the EC2 instance while it was creating this stack. 

## Edit the CloudFormer template

{: .box-note}
**Note:** You can just download the edited CloudFormation template from [this pastebin](https://pastebin.com/5fY5bAdb) or follow the steps below:

Grab the template JSON from the Template tab.

![image](https://user-images.githubusercontent.com/32394146/31494297-414438ce-af85-11e7-9e86-a66e935e42bc.png)

Edit this to add a key parameter under the `Parameters` node:

```json
"KeyName": {
      "Type": "String",
      "Description": "Keyname for the keypair that to login to EC2 instances",
      "Default": "My Key Pair"
    }
```

so that it looks like so:

![image](https://user-images.githubusercontent.com/32394146/31494379-a2a3b978-af85-11e7-851a-6fee0e2de9f8.png)

And associate this key with the EC2 instance. Search for the node `Properties` under `WebServer` and add this node

```json
 "KeyName": {
          "Ref": "KeyName"
        },
```


Set the `Default` value for the `KeyName` to your key (which can be found under [Key Pairs](https://console.amazonaws.cn/ec2/v2/home?region=cn-north-1#KeyPairs:sort=keyName))

Now delete the earlier CloudFormer stack (if you have one).

![image](https://user-images.githubusercontent.com/32394146/31494449-ec1e8060-af85-11e7-93f9-78ae32805c99.png)

And generate a new stack by pointing to this edited template

![image](https://user-images.githubusercontent.com/32394146/31494490-105f15b6-af86-11e7-9edf-1c417086c9fe.png)

# Add Incoming ports to Security Group

Now before logging in you need to add incoming port 22 to the Security Group the EC2 is part of. You can find this out, but clicking through 

![image](https://user-images.githubusercontent.com/32394146/31494921-f128d31a-af87-11e7-9615-5ae5a3b8805f.png)

Edit to add port 22 Inbound from your IP 


# Login to the EC2 to change Ports

You now have an EC2 machine with a key to login to.

![image](https://user-images.githubusercontent.com/32394146/31494774-6d181180-af87-11e7-9ad1-450fb219a564.png)

Now, I had no idea what webserver this was on, it wasn't Apache. Looking at `htop` I see 

![image](https://user-images.githubusercontent.com/32394146/31495634-f8e8a10e-af8a-11e7-9870-2af8188b5dd7.png)

this provides a clue. Googling for "thin server", I see that it's a Ruby webserver. Since this starts up with the server, we look at `/etc/rc.d/rc.local` to see the command that starts the server. We get:

```bash
[ec2-user@ip-172-31-4-114 ~]$ more /etc/rc.d/rc.local
#!/bin/sh
#
# This script will be executed *after* all the other init scripts.
# You can put your own initialization stuff in here if you don't
# want to do the full Sys V style init stuff.

touch /var/lock/subsys/local
/usr/bin/cloudformer
```

Listing out the startup script, we see:

```bash
[ec2-user@ip-172-31-4-114 ~]$ more /usr/bin/cloudformer
#!/usr/bin/env bash
cd /home/ec2-user/cloudformer
/usr/local/bin/thin start -p 443 -e production -d --ssl --ssl-key-file /home/ec2-user/cloudformer/.ssl/server.key --ssl-cert-file /home/ec2-user/cloudformer/.ssl/server.crt
```

We've finally reached the place where the port is specificed. We can see it's 443 above. Hence, we edit `/usr/bin/cloudformer` to change it to a port, say 8443. Now as before, edit your Security Group to add this port in the Incoming port section.

![image](https://user-images.githubusercontent.com/32394146/31495922-ffd1bc16-af8b-11e7-9ecf-322b823b819f.png)

## Access AWS CloudFormer

Reboot the EC2 instance and access the URL like so: `https://<your_ec2_hostname>:8443/`. You do get a certificate error, but ignore and proceed. You can now create a CloudFormation template of your environment.

![image](https://user-images.githubusercontent.com/32394146/31496323-83f7854c-af8d-11e7-8b30-f29c3c8623b4.png)
